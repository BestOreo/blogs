

## 数据库日志：undo 与 redo



数据库中有两类重要的文件：数据文件与日志文件。

#### 日志与数据的关系

用一个形象的比喻可以用来理解日志与数据的关系：日志好比是建筑设计图，数据文件就像是依照建筑设计图建造的高楼大厦。制作设计图的成本很低，只需一张纸一支笔；建设高楼大厦成本很高，但是高楼大厦有着实际的功能价值。如果高楼大厦崩塌了，依照设计图可以建造一个一模一样的建筑。

![img](https://www.fsi.com.my/wp-content/uploads/2009/08/%E5%BB%BA%E7%AD%91%E8%AE%BE%E8%AE%A1.jpg)

在计算机中，增删改查数据库的数据的代价( 可以理解为计算机的工作量 )很高，因为数据库的修改涉及到数据结构，磁盘存储，索引…… 日志好比一个普通的文本，记录了对于数据库的全部操作。如果数据库崩溃了，可以根据日志重新复现一个完全相同的数据库。

日志文件中有两类常见重要的日志：undo日志和redo日志。

####  undo日志

undo日志用于存放数据修改被修改前的值。假设修改表中 id=2的行数据，把Index='3' 修改为Value =**'美国队长3'** ，那么undo日志就会用来存放Name=**'美国队长2'**的记录。如果这个修改出现异常，可以使用undo日志来实现回滚操作，保证事务的一致性。

| Index |   Value    |
| :---: | :--------: |
|   0   | 泰坦尼克号 |
|   1   |  盗梦空间  |
|   2   | 寻梦环游记 |
|   3   | 美国队长2  |



对数据的变更操作，主要来自 INSERT UPDATE DELETE，而UNDO LOG中分为两种类型，一种是 INSERT_UNDO（INSERT操作），记录插入的唯一键值；一种是 UPDATE_UNDO（包含UPDATE及DELETE操作），记录修改的唯一键值以及old column记录。





#### redo日志

要理解redo日志，首先需要大致了解：

* 关键词：索引，数据库文件，页，Cache，内存。
* 内存数据一断电就丢失，磁盘数据可以长久保持。
* CPU操作内存数据的速度是操作磁盘数据的速度快好几个数量级；磁盘空间大小是内存的好几个数量级。
* 磁盘和内存交换数据很慢，4KB的数据一次性交换与4B数据的一次性交换对计算机的开销是相近的。
* 数据库文件存储在磁盘中，必要的时候按页(Page)读取到内存当中，然后进行操作。
* 操作完数据后，需要把内存中的数据库数据回写到磁盘上。



例如我们要更新数据库数据的时候，工作流程大致如下：

1. 首先根据从磁盘中的数据库文件中找到这部分记录。
2. 然后加载整页数据到内存的buffer pool，在内存中进行数据的操作。内存数据与磁盘数据出现了不一致，此时称之为脏页(dirty page)。
3. 为了保证数据一致，需要把脏页中的新数据回写覆盖磁盘中的旧数据。但是回写不会**立即发生**，因为这样会产生大量的随机IO操作，造成性能低下。但是**一段时间后**，回写必然会发生。



这就产生一个问题：如果不立即写回磁盘，那么当服务器挂掉后，存放在内存中的数据会丢失，造成数据的不一致性，也就无从持久化。**也就是说，用户以为数据已经更新了，但是计算机还没来得及将数据从内存写回磁盘就宕机了，重启以后内存数据全部丢失，计算机已经不记得这件事了**。为了解决这一矛盾，引入了redo日志，用于记录数据修改后的记录，这是一个顺序记录。它可以带来这些好处：

- 当buffer pool中的dirty page 还没有刷新到磁盘的时候，发生crash，启动服务后，可通过redo log 找到需要重新刷新到磁盘文件的记录；
- buffer pool中的数据直接flush到disk file，是一个随机IO，效率较差，而把buffer pool中的数据记录到redo log，是一个顺序IO，可以提高事务提交的速度；*[为什么是顺序IO，我还是不是很清楚，也许是引入了某种机制，例如根据数据的回写位置进行了排序]*



假设修改表中 id=2的行数据，把Index='3' 修改为Value =**'美国队长3'**  ，那么redo日志就会用来存放Value=**'美国队长3'**的记录，如果这个修改在flush到磁盘文件时出现异常，可以使用redo log实现重做操作，保证事务的持久性。

| Index |   Value    |
| :---: | :--------: |
|   0   | 泰坦尼克号 |
|   1   |  盗梦空间  |
|   2   | 寻梦环游记 |
|   3   | 美国队长2  |





####  **Undo + Redo事务的简化过程**

 假设有A、B两个数据，值分别为1,2，开始一个事务，事务的操作内容为：把1修改为3，2修改为4，那么实际的记录如下（简化）：

| 步骤ID | 操作                 |
| :----: | -------------------- |
|   1    | 事务开始.            |
|   2    | 记录A=1到undo log.   |
|   3    | 修改A=3.             |
|   4    | 记录A=3到redo log.   |
|   5    | 记录B=2到undo log.   |
|   6    | 修改B=4.             |
|   7    | 记录B=4到redo log.   |
|   8    | 将redo log写入磁盘。 |
|   9    | 事务提交             |



#### Undo 和 Redo的对比

区别 1

* undo 日志记录旧值
*  redo  日志记录新值

区别 2

* undo日志连续写入磁盘
* redo 日志一次性将数据写入磁盘





